version: '3.8'

services:
  # ============================================================================
  # Nexus RPC Server (Backend for MCP server or direct API access)
  # ============================================================================
  nexus-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: nexus-server:latest
    container_name: nexus-server
    restart: unless-stopped
    ports:
      - "${PORT:-2026}:2026"
    environment:
      - NEXUS_HOST=0.0.0.0
      - NEXUS_PORT=2026
      - NEXUS_DATA_DIR=/app/data
      - NEXUS_DATABASE_URL=${NEXUS_DATABASE_URL:-postgresql://postgres:nexus@postgres:5432/nexus}
      - NEXUS_API_KEY=${NEXUS_API_KEY:-}
      - NEXUS_BACKEND=${NEXUS_BACKEND:-local}
      # GCS Backend (if using)
      - NEXUS_GCS_BUCKET_NAME=${NEXUS_GCS_BUCKET_NAME:-}
      - NEXUS_GCS_PROJECT_ID=${NEXUS_GCS_PROJECT_ID:-}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-}
      # OAuth Configuration
      - NEXUS_OAUTH_ENCRYPTION_KEY=${NEXUS_OAUTH_ENCRYPTION_KEY:-}
      - NEXUS_OAUTH_GOOGLE_CLIENT_ID=${NEXUS_OAUTH_GOOGLE_CLIENT_ID:-}
      - NEXUS_OAUTH_GOOGLE_CLIENT_SECRET=${NEXUS_OAUTH_GOOGLE_CLIENT_SECRET:-}
      # Tiger Cache - disabled by default for simpler debugging
      - NEXUS_ENABLE_TIGER_CACHE=${NEXUS_ENABLE_TIGER_CACHE:-false}
    volumes:
      # Persistent data directory - use bind mount to match docker-compose.demo.yml
      - ./nexus-data:/app/data
      # Docker socket for sandbox container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Optional: Mount GCS credentials
      - ${GCS_CREDENTIALS_PATH:-./gcs-credentials.json}:/app/gcs-credentials.json:ro
    # Run as root to access Docker socket (required for sandbox provider)
    # The nexus user inside the container doesn't have socket permissions
    user: root
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2026/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - server  # Only run when explicitly requested

  # ============================================================================
  # MCP Server - HTTP Mode (Model Context Protocol for AI agents)
  # ============================================================================
  # Exposes Nexus functionality via MCP protocol for remote AI agent access
  # Connects to nexus-server as backend
  mcp-server:
    image: nexus-server:latest  # Reuse same image
    container_name: nexus-mcp-server
    restart: unless-stopped
    ports:
      - "${MCP_PORT:-8081}:8081"
    environment:
      # MCP Transport Configuration
      - MCP_TRANSPORT=${MCP_TRANSPORT:-http}
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8081

      # Backend Connection (connect to nexus-server)
      - NEXUS_URL=${NEXUS_URL:-http://nexus-server:2026}
      - NEXUS_API_KEY=${NEXUS_API_KEY:-}

      # Alternative: Local mode (comment out NEXUS_URL, uncomment below)
      # - NEXUS_BACKEND=${NEXUS_BACKEND:-local}
      # - NEXUS_DATA_DIR=/app/data
    volumes:
      # Only needed for local mode
      # - mcp-data:/app/data
      - ./logs:/app/logs:rw
    entrypoint: []  # Override entrypoint to skip database initialization
    command: ["nexus", "mcp", "serve", "--transport", "http", "--host", "0.0.0.0", "--port", "8081"]
    depends_on:
      nexus-server:
        condition: service_healthy
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - mcp  # Only run when explicitly requested

  # ============================================================================
  # DragonflyDB - Hot Cache (Architecture Simplified)
  # Redis-compatible in-memory cache for:
  # - Embedding cache (reduces API calls by 90%)
  # - Permission cache (hot path optimization)
  # - Tiger cache (bitmap pre-computation)
  # - Metadata hot cache (optional, SSOT is in Raft/sled)
  #
  # Uses cache_mode=true: allows eviction when memory is full
  # This is CACHE ONLY - all SSOT data is in Raft state machine (sled)
  # ============================================================================
  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly
    container_name: nexus-dragonfly
    restart: unless-stopped
    profiles:
      - cache  # Only starts with: docker compose --profile cache up
    command: >
      --cache_mode=true
      --maxmemory=512mb
      --proactor_threads=2
    ports:
      - "${DRAGONFLY_PORT:-6379}:6379"
    volumes:
      - dragonfly-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # NATS JetStream - Durable Event Bus (Issue #1331)
  # Replaces Dragonfly pub/sub for event delivery.
  # Provides: durable streams, replay, consumer groups, exactly-once semantics.
  # Dragonfly remains for hot caching only.
  # ============================================================================
  nats:
    image: nats:2.10-alpine
    container_name: nexus-nats
    restart: unless-stopped
    profiles:
      - events  # Only starts with: docker compose --profile events up
    command: ["--jetstream", "--store_dir=/data", "-m", "8222"]
    ports:
      - "${NATS_PORT:-4222}:4222"    # Client connections
      - "${NATS_MONITOR_PORT:-8222}:8222"  # HTTP monitoring
    volumes:
      - nats-data:/data
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:8222/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # NOTE: dragonfly-coordination has been REMOVED (Architecture Change)
  #
  # Previous role:
  # - Distributed locks (SSOT)
  # - Event bus pub/sub
  #
  # New architecture:
  # - Distributed locks -> Raft State Machine (sled)
  # - Metadata SSOT -> Raft State Machine (sled)
  # - dragonfly-cache remains for hot caching only
  #
  # See: docs/architecture/p2p-federation-consensus-zones.md
  # ============================================================================

  # ============================================================================
  # PostgreSQL - Test Instance (for cross-platform integration tests)
  # ============================================================================
  postgres-test:
    image: pgvector/pgvector:pg17
    container_name: nexus-postgres-test
    restart: unless-stopped
    profiles:
      - test  # Only starts with: docker compose --profile test up
    environment:
      POSTGRES_DB: nexus_test
      POSTGRES_USER: nexus_test
      POSTGRES_PASSWORD: nexus_test_password
    ports:
      - "${POSTGRES_TEST_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nexus_test -d nexus_test"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Linux NexusFS - Test Instance (for cross-platform lock tests)
  # Used for:
  # - Linux NexusFS + Redis integration tests
  # - Win → Linux cross-platform lock tests
  # - Linux → Win cross-platform lock tests
  # - startup_sync tests
  # ============================================================================
  nexus-linux-test:
    build:
      context: .
      dockerfile: Dockerfile
    image: nexus-server:latest
    container_name: nexus-linux-test
    restart: unless-stopped
    profiles:
      - test  # Only starts with: docker compose --profile test up
    depends_on:
      postgres-test:
        condition: service_healthy
    environment:
      - NEXUS_HOST=0.0.0.0
      - NEXUS_PORT=2027
      - NEXUS_DATA_DIR=/app/data
      # Locks and metadata are now in Raft state machine (sled), not dragonfly
      # dragonfly-coordination has been removed
      - NEXUS_TEST_MODE=1
      - NEXUS_ENFORCE_PERMISSIONS=false
      - PYTHONPATH=/app/src
    ports:
      - "${NEXUS_TEST_PORT:-2027}:2027"
    volumes:
      - nexus-test-data:/app/data
      # Mount source for running tests inside container
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    # Override entrypoint to avoid CRLF issues and keep container running for tests
    entrypoint: []
    command: ["python", "-c", "import time; print('Linux NexusFS test container ready'); time.sleep(86400)"]
    healthcheck:
      test: ["CMD", "python", "-c", "import nexus; print('ok')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  nexus-data:
    driver: local
  dragonfly-data:
    driver: local
  nats-data:
    driver: local
  nexus-test-data:
    driver: local

networks:
  nexus-network:
    driver: bridge
