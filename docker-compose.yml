version: '3.8'

services:
  # ============================================================================
  # Nexus RPC Server (Backend for MCP server or direct API access)
  # ============================================================================
  nexus-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: nexus-server:latest
    container_name: nexus-server
    restart: unless-stopped
    ports:
      - "${PORT:-2026}:2026"
    environment:
      - NEXUS_HOST=0.0.0.0
      - NEXUS_PORT=2026
      - NEXUS_DATA_DIR=/app/data
      - NEXUS_DATABASE_URL=${NEXUS_DATABASE_URL:-postgresql://postgres:nexus@postgres:5432/nexus}
      - NEXUS_API_KEY=${NEXUS_API_KEY:-}
      - NEXUS_BACKEND=${NEXUS_BACKEND:-local}
      # GCS Backend (if using)
      - NEXUS_GCS_BUCKET_NAME=${NEXUS_GCS_BUCKET_NAME:-}
      - NEXUS_GCS_PROJECT_ID=${NEXUS_GCS_PROJECT_ID:-}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-}
      # OAuth Configuration
      - NEXUS_OAUTH_ENCRYPTION_KEY=${NEXUS_OAUTH_ENCRYPTION_KEY:-}
      - NEXUS_OAUTH_GOOGLE_CLIENT_ID=${NEXUS_OAUTH_GOOGLE_CLIENT_ID:-}
      - NEXUS_OAUTH_GOOGLE_CLIENT_SECRET=${NEXUS_OAUTH_GOOGLE_CLIENT_SECRET:-}
      # Tiger Cache - disabled by default for simpler debugging
      - NEXUS_ENABLE_TIGER_CACHE=${NEXUS_ENABLE_TIGER_CACHE:-false}
      # TigerBeetle for Nexus Pay (optional - disabled by default)
      - TIGERBEETLE_ENABLED=${TIGERBEETLE_ENABLED:-false}
      - TIGERBEETLE_ADDRESS=${TIGERBEETLE_ADDRESS:-tigerbeetle:3000}
    volumes:
      # Persistent data directory - use bind mount to match docker-compose.demo.yml
      - ./nexus-data:/app/data
      # Docker socket for sandbox container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Optional: Mount GCS credentials
      - ${GCS_CREDENTIALS_PATH:-./gcs-credentials.json}:/app/gcs-credentials.json:ro
    # Run as root to access Docker socket (required for sandbox provider)
    # The nexus user inside the container doesn't have socket permissions
    user: root
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2026/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - server  # Only run when explicitly requested

  # ============================================================================
  # MCP Server - HTTP Mode (Model Context Protocol for AI agents)
  # ============================================================================
  # Exposes Nexus functionality via MCP protocol for remote AI agent access
  # Connects to nexus-server as backend
  mcp-server:
    image: nexus-server:latest  # Reuse same image
    container_name: nexus-mcp-server
    restart: unless-stopped
    ports:
      - "${MCP_PORT:-8081}:8081"
    environment:
      # MCP Transport Configuration
      - MCP_TRANSPORT=${MCP_TRANSPORT:-http}
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8081

      # Backend Connection (connect to nexus-server)
      - NEXUS_URL=${NEXUS_URL:-http://nexus-server:2026}
      - NEXUS_API_KEY=${NEXUS_API_KEY:-}

      # Alternative: Local mode (comment out NEXUS_URL, uncomment below)
      # - NEXUS_BACKEND=${NEXUS_BACKEND:-local}
      # - NEXUS_DATA_DIR=/app/data
    volumes:
      # Only needed for local mode
      # - mcp-data:/app/data
      - ./logs:/app/logs:rw
    entrypoint: []  # Override entrypoint to skip database initialization
    command: ["nexus", "mcp", "serve", "--transport", "http", "--host", "0.0.0.0", "--port", "8081"]
    depends_on:
      nexus-server:
        condition: service_healthy
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - mcp  # Only run when explicitly requested

  # ============================================================================
  # DragonflyDB - Cache Instance (Issue #950)
  # Redis-compatible in-memory cache for:
  # - Embedding cache (reduces API calls by 90%)
  # - Permission cache
  # - Tiger cache
  # Uses cache_mode=true: allows eviction when memory is full
  # ============================================================================
  dragonfly-cache:
    image: docker.dragonflydb.io/dragonflydb/dragonfly
    container_name: nexus-dragonfly-cache
    restart: unless-stopped
    profiles:
      - cache  # Only starts with: docker compose --profile cache up
    command: >
      --cache_mode=true
      --maxmemory=512mb
      --proactor_threads=2
    ports:
      - "${DRAGONFLY_CACHE_PORT:-6379}:6379"
    volumes:
      - dragonfly-cache-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # DragonflyDB - Coordination Instance (Issue #1106)
  # Redis-compatible in-memory store for:
  # - Distributed locks (must NOT be evicted)
  # - Event bus pub/sub
  # Uses cache_mode=false + noeviction: data is never evicted
  # ============================================================================
  dragonfly-coordination:
    image: docker.dragonflydb.io/dragonflydb/dragonfly
    container_name: nexus-dragonfly-coordination
    restart: unless-stopped
    profiles:
      - cache  # Only starts with: docker compose --profile cache up
      - test   # Also needed for test profile
    command: >
      --cache_mode=false
      --maxmemory=256mb
      --proactor_threads=1
    ports:
      - "${DRAGONFLY_COORDINATION_PORT:-6380}:6379"
    volumes:
      - dragonfly-coordination-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # TigerBeetle - Financial Ledger (Issue #1205)
  # High-performance ledger for:
  # - Agent credit balances
  # - Two-phase transfers (reservations)
  # - API metering / rate limiting
  # 40k+ TPS, <1ms latency
  # ============================================================================
  tigerbeetle:
    image: ghcr.io/tigerbeetle/tigerbeetle:latest
    container_name: nexus-tigerbeetle
    restart: unless-stopped
    profiles:
      - pay   # Only starts with: docker compose --profile pay up
      - test  # Also starts with test profile for integration tests
    ports:
      - "${TIGERBEETLE_PORT:-3000}:3000"
    volumes:
      - tigerbeetle-data:/data
    # TigerBeetle requires special permissions for direct I/O
    security_opt:
      - seccomp=unconfined
    # Required for memory locking on macOS
    cap_add:
      - IPC_LOCK
    # Format data file on first run, then start server
    # Using shell to handle first-run initialization
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        if [ ! -f /data/0_0.tigerbeetle ]; then
          echo "Formatting TigerBeetle data file..."
          /tigerbeetle format --cluster=0 --replica=0 --replica-count=1 /data/0_0.tigerbeetle
        fi
        echo "Starting TigerBeetle server..."
        exec /tigerbeetle start --addresses=0.0.0.0:3000 --cache-grid=256MiB /data/0_0.tigerbeetle
    healthcheck:
      # TigerBeetle doesn't have HTTP health endpoint, check if port is listening
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # PostgreSQL - Test Instance (for cross-platform integration tests)
  # ============================================================================
  postgres-test:
    image: pgvector/pgvector:pg17
    container_name: nexus-postgres-test
    restart: unless-stopped
    profiles:
      - test  # Only starts with: docker compose --profile test up
    environment:
      POSTGRES_DB: nexus_test
      POSTGRES_USER: nexus_test
      POSTGRES_PASSWORD: nexus_test_password
    ports:
      - "${POSTGRES_TEST_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nexus_test -d nexus_test"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Linux NexusFS - Test Instance (for cross-platform lock tests)
  # Used for:
  # - Linux NexusFS + Redis integration tests
  # - Win → Linux cross-platform lock tests
  # - Linux → Win cross-platform lock tests
  # - startup_sync tests
  # ============================================================================
  nexus-linux-test:
    build:
      context: .
      dockerfile: Dockerfile
    image: nexus-server:latest
    container_name: nexus-linux-test
    restart: unless-stopped
    profiles:
      - test  # Only starts with: docker compose --profile test up
    depends_on:
      dragonfly-coordination:
        condition: service_healthy
      postgres-test:
        condition: service_healthy
    environment:
      - NEXUS_HOST=0.0.0.0
      - NEXUS_PORT=2027
      - NEXUS_DATA_DIR=/app/data
      # Don't set NEXUS_DATABASE_URL - tests use local SQLite
      # PostgreSQL is only for startup_sync tests which set it explicitly
      - NEXUS_DRAGONFLY_COORDINATION_URL=redis://dragonfly-coordination:6379
      - NEXUS_TEST_MODE=1
      - NEXUS_ENFORCE_PERMISSIONS=false
      - PYTHONPATH=/app/src
    ports:
      - "${NEXUS_TEST_PORT:-2027}:2027"
    volumes:
      - nexus-test-data:/app/data
      # Mount source for running tests inside container
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    # Override entrypoint to avoid CRLF issues and keep container running for tests
    entrypoint: []
    command: ["python", "-c", "import time; print('Linux NexusFS test container ready'); time.sleep(86400)"]
    healthcheck:
      test: ["CMD", "python", "-c", "import nexus; print('ok')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  nexus-data:
    driver: local
  dragonfly-cache-data:
    driver: local
  dragonfly-coordination-data:
    driver: local
  tigerbeetle-data:
    driver: local
  nexus-test-data:
    driver: local

networks:
  nexus-network:
    driver: bridge
