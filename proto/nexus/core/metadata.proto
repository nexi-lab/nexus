// FileMetadata - shared metadata message used across Nexus.
//
// This is the canonical protobuf definition for file metadata,
// used by both the Python gRPC layer and the Rust Raft state machine.
//
// SSOT: This file is the single source of truth for FileMetadata serialization.

syntax = "proto3";

package nexus.core;

// Directory entry type — classifies what a path represents.
// Mirrors POSIX d_type but for the Nexus virtual filesystem.
enum DirEntryType {
  DT_REG = 0;     // Regular file (proto3 default)
  DT_DIR = 1;     // Directory
  DT_MOUNT = 2;   // Mount point to another zone
}

// FileMetadata represents the metadata for a single file or directory in Nexus.
//
// All string fields use empty string as the default/absent value.
// Timestamps are stored as ISO 8601 strings for cross-language compatibility.
message FileMetadata {
  // Virtual path in the Nexus filesystem (e.g., "/docs/README.md").
  string path = 1;

  // Storage backend name (e.g., "local", "s3", "gcs").
  string backend_name = 2;

  // Physical path on the backend storage.
  string physical_path = 3;

  // File size in bytes.
  int64 size = 4;

  // Content hash / ETag for CAS deduplication.
  string etag = 5;

  // MIME type of the file (e.g., "text/plain").
  string mime_type = 6;

  // Creation timestamp (ISO 8601 string).
  string created_at = 7;

  // Last modification timestamp (ISO 8601 string).
  string modified_at = 8;

  // Metadata version number (starts at 1).
  int32 version = 9;

  // Zone ID for multi-zone deployments.
  string zone_id = 10;

  // User or agent ID who created/modified this version.
  string created_by = 11;

  // Owner ID for O(1) permission checks (posix_uid).
  string owner_id = 12;

  // Entry type: DT_REG (0), DT_DIR (1), or DT_MOUNT (2).
  // SSOT for file/directory/mount distinction.
  DirEntryType entry_type = 13;

  // Target zone ID for DT_MOUNT entries. Only set when entry_type == DT_MOUNT.
  // Contains the zone_id of the mounted zone for cross-zone path resolution.
  string target_zone_id = 14;

  // Reference count — number of DT_MOUNT entries pointing to this zone.
  // Follows POSIX i_nlink semantics (cf. shared_ptr reference counting):
  //   zone create  → i_links_count = 0   (no references yet)
  //   mount        → i_links_count++     (like link() / shared_ptr copy)
  //   unmount      → i_links_count--     (like unlink() / shared_ptr dtor)
  //   count == 0   → zone is destroyable (like free inode / shared_ptr delete)
  int32 i_links_count = 15;
}
